# FundPilot-AI 基金智能定投决策系统 · 需求规格说明书 (v1.0 Final)

**文档状态：** 最终定稿
**适用版本：** v1.0
**更新日期：** 2026-01-28

---

## 1. 项目综述 (Project Overview)

### 1.1 项目定义
**FundPilot-AI** 是一款部署于云端服务器的**轻量级自动化辅助决策系统**。系统仅在中国 A 股交易日的特定时间窗口（14:00-15:00）运行，通过获取基金实时估值、历史净值及持仓表现，利用量化指标与 DeepSeek AI 进行联合分析，通过邮件向用户推送**具备纪律性**的定投操作建议。

### 1.2 核心目标
* **克服人性弱点：** 利用数据客观判断“贵贱”，执行**“低估多买、高估停买”**的网格策略。
* **规避交易磨损：** 针对 **A类份额**（高赎回费）特性，策略核心为“只买不卖”（止盈通过暂停定投实现）。
* **深度归因：** 不仅给出涨跌，还通过分析重仓股表现，解释“为什么涨/跌”。

---

## 2. 投资标的与核心策略 (Investment Strategy)

系统需支持通过 `config.yaml` 配置不同类型基金，并应用分裂式策略逻辑。

### 2.1 策略 A：ETF 联接基金 (A类)
* **特征：** 高波动，与指数强相关。
* **核心量化指标：** **60日分位值 (60-Day Percentile)**。
    * *公式：* `(今日预估价 - 60日最低价) / (60日最高价 - 60日最低价)`
* **AI 决策模型 (Grid Trading)：**
    * **黄金坑 (分位 < 20%)：** 建议 **倍数补仓** (x1.5 ~ x2.0)。
    * **合理区 (分位 20%-80%)：** 建议 **正常定投** 或 **观望**。
    * **高估区 (分位 > 80%)：** 建议 **暂停定投** (积攒现金)，严禁追高。
* **归因要求：** 必须结合**前十大重仓股**的实时表现进行分析。

### 2.2 策略 B：债券基金 (A类)
* **特征：** 低波动，收益稳健。
* **核心量化指标：** **回撤幅度 (Drawdown) & 均线乖离**。
* **AI 决策模型 (Defensive Buy)：**
    * **正常波动：** 建议持有，安抚心态。
    * **机会信号：** 仅在 **跌破 60日均线** 或 **单日跌幅 > 0.15%** (视作债券大跌) 时，提示买入机会。

---

## 3. 数据架构与存储方案 (Data Architecture)

### 3.1 数据库选型 (Database)
* **类型：** **SQLite** (v3)。
* **理由：** 零配置、单文件、适合云服务器单机部署。
* **用途：**
    * **数据缓存：** 存储每日获取的历史净值（避免每次启动重复拉取60天数据）。
    * **决策日志：** 记录每次 AI 发出的建议、当时的估值及决策理由（用于后续回测优化）。
* **ORM框架：** 建议使用 Python 原生 `sqlite3` 或轻量级 `SQLAlchemy Core`。

### 3.2 核心数据源 (Data Sources)
* **数据锚点：** **天天基金网 (EastMoney)**。
* **技术栈：**
    * **AkShare:** 用于获取历史净值、静态持仓列表。
    * **Direct API (Requests):** 直连天天基金轻量级接口，用于高频获取盘中估值。
    * **网络策略：** 使用 `requests` + `tenacity` 实现指数退避重试 (Retry)，**不引入** Playwright 等重型浏览器自动化工具。

### 3.3 数据获取清单 (Data Points)

#### A. 盘中实时估值 (Real-time)
* **对象：** 目标基金。
* **频率：** 运行时（14:30, 14:50）。
* **实效性校验：** 必须解析返回包中的 `gztime`。若 `当前时间 - gztime > 30分钟`，标记为**数据失效**，触发降级处理（仅发送历史数据）。

#### B. 历史净值 (History)
* **对象：** 目标基金。
* **范围：** 过去 **60个交易日**。
* **用途：** 计算 `Max_60`, `Min_60`, `Avg_60` (MA60) 及当前分位值。

#### C. 持仓穿透分析 (Holdings Analysis - v1.0)
* **静态映射：** 启动时获取基金 **前十大重仓股** 代码。
    * *特殊逻辑：* 对于 ETF 联接基金，需配置映射表，穿透查询其**底层场内 ETF** 的持仓。
* **动态行情：** 运行时并发获取这 10 只股票的 **今日实时涨跌幅**。
* **计算：** 加权计算重仓股对基金净值的贡献度，生成 Context 喂给 AI。

#### D. 市场环境 (Market Context)
* **对象：** 上证指数、沪深300 或相关行业指数。
* **指标：** 当日实时涨跌幅。

---

## 4. AI 决策引擎 (AI Engine)

* **模型服务：** DeepSeek API。
* **角色设定：** 理性的纪律执行官 (Disciplined Execution Officer)。
* **输入上下文 (JSON Context 示例)：**

```json
{
  "fund_name": "半导体ETF联接A",
  "fund_type": "ETF_Feeder",
  "real_time_metrics": {
    "estimate_change": "-2.15%",
    "percentile_60": 12.5,
    "ma_60_price": 1.150,
    "current_price_est": 1.080
  },
  "holdings_insight": {
    "top_losers": ["中芯国际 (-8.2%)", "韦尔股份 (-3.1%)"],
    "summary": "前十大重仓股中 8 家下跌，核心权重股领跌。"
  },
  "market_context": {
    "shanghai_index": "-0.5%",
    "sector_index": "-1.8%"
  }
}
```

* **输出规范：**
    1.  **核心指令：** 必须明确给出 [双倍补仓 / 正常定投 / 暂停定投 / 观望] 之一。
    2.  **简短理由：** 结合“位置感（分位值）”和“持仓归因”进行解释。

---

## 5. 可视化模块 (Visualization)

* **图表类型：** **"10 + 1" 趋势图**。
* **构成：**
    * **历史 (10)：** 前 10 个交易日的实际净值（实线）。
    * **预测 (1)：** 第 10 点至今日预估价的连线（虚线）。
        * *配色：* 涨红、跌绿。
    * **参考线 (关键)：** 必须绘制 **60日均线 (MA60)** 水平线，作为强弱分界参考。
* **技术限制：** 使用 `Matplotlib` 的 `Agg` 后端，直接生成图片字节流，**不显示窗口**。

---

## 6. 系统架构与非功能需求 (Technical Specs)

### 6.1 运行环境
* **OS:** Linux (Ubuntu/CentOS), Headless Mode.
* **Language:** Python 3.9+.
* **Timezone:** 代码级强制硬编码 `TZ='Asia/Shanghai'`。

### 6.2 任务调度 (Scheduler)
* **工具:** `APScheduler` (Blocking/Background)。
* **触发时间:** 周一至周五 `14:30` (预警), `14:50` (决策)。
* **交易日过滤 (Calendar Filter):**
    1.  **周末过滤:** 排除周六日。
    2.  **节假日过滤:** 集成 `chinesecalendar` 库，排除法定节假日。
    3.  **API 二次校验:** 再次校验 AkShare 交易日接口或实时数据的 `gztime`。

### 6.3 健壮性与日志 (Robustness)
* **日志系统:** 使用 `logging` 模块 (RotatingFileHandler)。禁止使用 `print`。
    * *Info:* 任务启停、决策结果。
    * *Error:* API 超时、数据解析错误。
* **容错机制:**
    * **网络:** 所有 API 请求均需包裹 `tenacity` 重试装饰器 (Stop: 3 times, Wait: Exponential)。
    * **降级:** AI 接口超时 -> 仅发送数据邮件；实时数据获取失败 -> 邮件提示“暂停服务”。

---

## 7. 交付物标准 (Deliverables)

系统最终产出为 **HTML 格式邮件**，包含以下模块：

1.  **标题：** `【FundPilot】14:50 决策: [双倍补仓] - 预估 -2.15% (半导体ETF)`
2.  **核心结论区：** 高亮显示 AI 给出的操作指令及简短分析。
3.  **数据看板 (Table)：**
    * 今日涨跌幅 (预估)
    * 60日分位值 (%)
    * 60日均线偏离度 (%)
4.  **趋势图表：** 内嵌 "10+1" 趋势图片。
